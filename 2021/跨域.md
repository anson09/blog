---
order: 10
---

# 跨域

## Terms

`ORIGIN = PROTOCOL :// HOST : PORT`

**SAME ORIGIN** needs three factors keep the same  
**SAME SITE** needs only the host is same

## Resources Load

- js、css、img、document、ws（会带上 origin）跨域请求，无需 cors 配置
- xhr、font 跨域请求，需要 cors 配置
- web worker/service worker 不允许跨域，配 cors 也不行，需用 blob url

## Secutiry Strategy

- iframe 内请求的跨域判断是相对于浏览器地址, 不是相对于 iframe src 地址
- cookie 的 domain 和 path 字段生效是相对于请求 url (url contain sub domain/path could visit it's parent filed cookie, but not vice versa), 所以原来采用 csrf-token 解决 csrf 问题， 后来引入 Samesite 字段是相对于浏览器地址
- iframe 内部请求的 cookie 是否携带在跨域时受 SameSite 默认行为 Lax 管控. SameSite 属性可通过 js 操作 cookie 修改( Secure 属性为 true 时 ), 但无法操作跨域 cookie, 因此 CSRF 就基本杜绝了
- CORS 时要携带 cookie，`Access-Control-Allow-Origin` 要指定域名不能用 `*`，同时设置 [`Access-Control-Allow-Credentials`](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Credentials) 和 fetch 中的 `credentials` 参数
- 跨域不允许操作不同源的 DOM 是指不同 iframe 或 tab 的 DOM 无法互访, 而不是指跨域加载的脚本不能操作当前页面的 DOM. 脚本只要 CSP（XSS killer） 允许执行, 就能操作

## Domain Hack

Different subdomains's domain value `a.example.com | b.example.com` could be updated by `document.domain = 'example.com'`.After this change, we get a same origin. Now different subdomains page could access each other's window and domcument object, therefore DOM、Cookie、Localstorage、Indexdb operation are all available.

Restrictions:

- Domain can only set to current domain's suffix, but root domain is not allowed
- Both subdomains need do `document.domain` set operation, even if one of them has already been the target domain
- Protocol need same (Mixing http and https is not allowed)
- Port is not display in `document.domain`, and each domain use different port number doesn't matter
- Ajax/Fetch are still obey cross domain rules, cause it check browser url rather than `document.domain`
- Cookies carry is still obey SameSite and CORS rules
- After [chrome 109](https://developer.chrome.com/blog/immutable-document-domain/), `document.domain` will be readonly， unless all domains set a `Origin-Agent-Cluster: ?0` header

With so many restrictions, you'd better use postMessage to do pages communication.
